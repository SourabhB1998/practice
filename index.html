<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="utf-8" />
    <title>Composition View</title>

    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="stylesheet" href="./css/tagStyle.css" type="text/css">
    <link rel="stylesheet" href="./css/snackbar.css" type="text/css">
    <link rel="stylesheet" href="./css/jquery.mentionsInput.css" type="text/css">


    <link href="./css/font-awesome.min.css" rel="stylesheet" />
    <link href="./css/bootstrap-multiselect.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/compositionView.css" />
    <link rel="stylesheet" href="./css/common.css" />


    <script src="./js/jquery-3.4.1.js"></script>
    <script src="./js/underscore-min.js"></script>
    <script src="./js/es6-promise.js"></script>
    <script src="./js/mentionsInput.js"></script>
    <script src="./js/jquery.elastic.js"></script>
    <script src="./js/jquery.events.input.js"></script>
    <script src="./js/jquery.toaster.js"></script>
    <script src="./js/poper.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/multi-select.js"></script>
    <script src="./js/highcharts.js"></script>
    <script src="./js/highstock.js"></script>
    <script src="./js/exporting.js"></script>
    <script src="./js/export-data.js"></script>
    <script src='./js/httpintercptor.js'></script>
    <script src="./js/dashboardDetails.js"></script>
    <script src='./js/common.js'></script>
    <script src="./js/bulletchart.js"></script>
    <script src="./js/chart-bot.js"></script>
    <script src="./js/mentionsInput.js"></script>
    <script src="./js/chatbot.js" type='text/javascript'></script>
    <script src="./js/moment.js"></script>
    <script src="./js/jsonToCsv.js"></script>
    <script src='./js/highchart-digilytics.js'></script>
    <script src='./js/bulletchart.js'></script>
    <script src='./js/crypto.js'></script>
</head>

<body>
    <div class="row reportTitleRow">
        <div class="col-sm-12 reportTitleBar">
            <div class="lastRefreshedDateTitle" style="    float: left;color: azure;font-size: 13px;margin-right: -20vw;">Last Refreshed( Bill Date) - <span id="lastRefreshedDateId"></span></div>
            <div id="reportId" style="    color: white;
            font-weight: 700;">Strategic Overview : Composition View</div>
            <div class="lastRefreshedDateTitle" style="    float: left;color: azure;font-size: 13px;margin-right: -20vw;">Source: Daily Sales</div>
            <!-- <div class="reportSubTitle">Geo Hierarchy</div> -->
            <div class="reportImg">
                <img src="./images/daburlogo.jpg" alt="logo">
            </div>
        </div>
    </div>
    <div class="row filterRow">
        <div>
            <span class="heading">Filters</span>
        </div>

        <div class="col filterCol">
            <div class="filterTitle">Year</div>
            <select name="year" class="filter" id="yearFilter">
            </select>
        </div>
        <div class="col filterCol">
            <div class="filterTitle">Month</div>
            <select name="month" class="filter" id="monthFilter">
            </select>
        </div>
        <div class="col filterCol">
            <div class="filterTitle">Brand</div>
            <select name="brand" class="filter" id="brand_filter_id">
            </select>
        </div>
        <div class="col filterCol">
            <div class="filterTitle">SKU</div>
            <select name="sku" class="filter" multiple='multiple' id="sku_filter_id">
            </select>
        </div>
    </div>
    <div class="mainContent" style="width:97%">
        <div class="row chartRow">
            <div class="col-md-4 chartCol" id='zoneContainer'>
                <div class="chartSubCol">
                    <div id='zonewiseSalesDivId' class="chartDiv"></div>
                </div>
                <div class="chartSubCol">
                    <div id='zonewiseSpendDivId' class="chartDiv"></div>
                </div>
            </div>


            <div class="col-md-4 chartCol" id='nobContainer'>
                <div class="chartSubCol">
                    <div id='nobwiseSalesDivId' class="chartDiv"></div>
                </div>
                <div class="chartSubCol">
                    <div id='nobwiseSpendDivId' class="chartDiv"></div>
                </div>
            </div>

            <div class="col-md-4 chartCol" id='skuContainer'>
                <div class="navigation" id='salesNavigationId'>
                    <span class='prevN' title='Prev'>
                            <i onclick="navigateSalesSkuChart('prev')" class="fa fa-chevron-left"
                               aria-hidden="true"></i></span>
                    <span class="nextN" title='Next'>
                            <i onclick="navigateSalesSkuChart('next')" class="fa fa-chevron-right" aria-hidden="true"></i>
                        </span>
                </div>
                <div class="chartSubCol">
                    <div id='skuwiseSalesDivId' class="chartDiv"></div>
                </div>
                <div class="navigation" id='spendNavigationId'>
                    <span class='prevNSpnd' title='Prev'>
                            <i onclick="navigateSpendSkuChart('prev')" class="fa fa-chevron-left"
                               aria-hidden="true"></i></span>
                    <span class="nextNSpnd" title='Next'>
                            <i onclick="navigateSpendSkuChart('next')" class="fa fa-chevron-right"
                               aria-hidden="true"></i></span>
                </div>
                <div class="chartSubCol">
                    <div id='skuwiseSpendDivId' class="chartDiv"></div>
                </div>
            </div>

        </div>
    </div>
    <div style="width: 5%;float: right;margin-top: -36%;"> 
        <div id="goButton" title="Filter Change" style="float: right;margin-bottom: 1%;">
            <button type="button" style="      
            height: 25px;font-size: 11px;" id="filterChange" class="btn btn-success">Go</button>
        </div>
        <a style="color:blue;cursor: pointer; float: right;margin-right: 5%;" onclick="refreshDashboard()"> <i class="fa fa-eraser">Reset</i></a>
    </div>

    <div style="display: none;">
        <select id="monthDependantComboId"></select>
    </div>
    <div style="display: none;">
        <select id="skuDependantComboId"></select>
    </div>

    <input style="display: none;" id="companyId">
    <input style="display: none;" id="userId">
    <input style="display: none;" id="dashboardId">
    <input style="display: none;" id="reportTitle">

    <input style="display: none;" id="baseURL">
    <input style="display: none;" id="restBaseURL">
    <input style="display: none;" id="chatURL">
    <input style="display: none;" id="allowedEmailDomains">

</body>


<script>
    var monthArr = ["January", "February", "March", "April", "May", "June", "July",
        "August", "September", "October", "November", "December"
    ];
    var globalColorsArr = ['#2f7ed8', '#0d233a', '#8bbc21', '#21b7bc', '#e87810', '#83e810', '#e82d10', '#bc217e', '#3621bc',
        '#2171bc', '#10e871', '#8121bc', '#e8bd10', '#e81010', '#3b21bc', '#1710e8', '#21bcaa', '#7c79e8', '#254523', '#242436', '#8a3a3a', '#0d0707', '#2d3466'
    ];

    var skuwiseCompositionReqObj;
    var skuLimit = 4;
    var currSkuSalesPage = 1;
    var currSkuSpendPage = 1;
    var globalSkuSpendChartData = [];
    var globalSkuSalesChartData = [];
    var globalChartSelectionFilter = null;
    var globalSkuFilterData = [];
    let categoryList;
    let onload = true;
    let preSeletedValue = '';
    let filterValueSku = [];

    showHideLoader('skuContainer', true);
    showHideLoader('nobContainer', true);
    showHideLoader('zoneContainer', true);
    $("#filterChange").hide();
    filterComboApi();

    function filterComboApi() {
        $.ajax({
            url: getApiDomain(),
            type: "POST",
            data: JSON.stringify({
                filter: "Year_Month_Filters"
            }),
            success: (function(dataResult) {
                let data = dataResult.data.data;
                if (userId != undefined) {
                    trackCustomPageLoadEvent('Report Open', {
                        "companyId": companyId.toString(),
                        "userId": userId.toString(),
                        "dashboardId": dashboardId.toString(),
                        "reportName": dashboardFullName.toString()
                    });
                }
                let selected = '';
                let yearArr = [];
                let yearIndex = -1;
                let firstYearVal = data[0].length > 0 ? data[0][0].year : "";
                for (let i = 0, temp = data[0]; i < temp.length; i++) {
                    yearIndex = yearArr.findIndex(obj => obj.year == temp[i].year);
                    if (yearIndex == -1) {
                        yearArr.push({
                            full_fiscal_year: temp[i].full_fiscal_year,
                            year: temp[i].year
                        });
                    }
                    $("#monthDependantComboId").append("<option class='" + temp[i].full_fiscal_year + "' value='" + parseInt(temp[i].month_no * 1) + "'>" + temp[i].month_nm + "</option>")
                    selected = ""
                    if (i == 0) {
                        selected = "selected"
                    }
                    if (firstYearVal == temp[i].year) {
                        $("#monthFilter").append("<option value='" + parseInt(temp[i].month_no * 1) + "' " + selected + ">" + temp[i].month_nm + "</option>")
                    }
                }

                //YEAR SELECT
                for (let i = 0; i < yearArr.length; i++) {
                    let selected = '';
                    $("#yearFilter").append("<option " + selected + " value='" + yearArr[i].full_fiscal_year + "'>" + yearArr[i].year + "</option>")
                }
                populateFilterCombo();

            }),
            error: (function(err) {
                if (err.status == 404) {
                    $(".mainContent").html("<p><h3  style='text-align: center; color: #e7875c;'>Server is down due to regular maintenance activities by our experts. Regret for inconvenience caused. Please access the dashboards again in a while ! </h3></p>");
                }
                console.log(err);
            })
        });
    }

    function populateFilterCombo() {
        let month = $('#monthFilter').val();
        let year = '';
        $("#yearFilter option:selected").each(function() {
            var $this = $(this);
            if ($this.length) {
                var selText = $this.text();
                year += selText
            }
        });
        let filterData = [];
        let brandValue = $("#brand_filter_id").val();
        filterData.push({
            dataType: "String",
            key: 'Year',
            value: year.toString()
        });
        filterData.push({
            dataType: "String",
            key: 'Month',
            value: month.toString()
        });
        if (brandValue != null) {
            preSeletedValue = brandValue;
            filterData.push({
                dataType: "String",
                key: 'brand',
                value: brandValue.toString()
            });
        }
        $.ajax({
            url: getApiDomain(),
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                filter: "filter_Options_Dependency_V1",
                'chartDataForms': filterData
            }),
            success: function(dataResult) {
                let data = dataResult.data.data;
                //Brand Select
                if (onload) {
                    $("#brand_filter_id").empty();
                    for (let i = 0, temp = data[2]; i < temp.length; i++) {
                        selected = "";
                        if (preSeletedValue != '' && temp[i].brand == preSeletedValue) {
                            selected = 'selected';
                        } else if (temp[i].brand == "Real 1 Ltr") {
                            selected = 'selected';
                        }
                        $("#brand_filter_id").append("<option value='" + temp[i].id + "' " + selected + " >" + temp[i].brand + "</option>")
                    }
                }
                //SKU  Select 
                $("#sku_filter_id").empty();
                let seleBrand = $("#brand_filter_id").val();
                for (let i = 0, temp = data[3]; i < temp.length; i++) {
                    if (temp[i].brand_id == parseInt(seleBrand)) {
                        if (filterValueSku.length != 0 && filterValueSku.includes(temp[i].id)) {
                            selected = 'selected';
                        } else if (filterValueSku.length == 0) {
                            selected = 'selected';
                        } else {
                            selected = '';
                        }

                        $("#sku_filter_id").append("<option value='" + temp[i].id + "' " + selected + " >" + temp[i].sku + "</option>")
                    }
                }
                $("#sku_filter_id").multiselect('destroy');
                $('#sku_filter_id').multiselect({
                    allSelectedText: 'All',
                    numberDisplayed: 1,
                    nonSelectedText: 'All',
                    includeSelectAllOption: true,
                    enableFiltering: true,
                    enableCaseInsensitiveFiltering: true
                });
                if (onload) {
                    onload = false;
                    yearMonthObjAPi();
                }
                global_initialFilterData = getAllFiltersData();
            },
            error: function(err) {
                console.log(err);
            }
        });
    }
    var yearMonthRequestObj;
    var yearMonthObj = {};

    function yearMonthObjAPi() {
        if (yearMonthRequestObj) {
            yearMonthRequestObj.abort();
            yearMonthRequestObj = null;
        }
        yearMonthObj = {};
        let year = $("#yearFilter option:selected").text();
        let month = $('#monthFilter').val();

        let ficiYear = parseInt(year.substr(2, 2));
        let lastFicicalYear = "FY" + --ficiYear + "-" + year.substr(2, 2);
        categoryList = [lastFicicalYear, year];

        let data = [];
        data.push({
            dataType: "String",
            key: 'yearFY',
            value: year.toString()
        });
        data.push({
            dataType: "String",
            key: 'month',
            value: month.toString()
        });

        yearMonthRequestObj = $.ajax({
            type: 'POST',
            url: getApiDomain(),
            data: JSON.stringify({
                'filter': "YearMonth_Procedure",
                'chartDataForms': data
            }),
            success: (function(dataResult) {
                let data = dataResult.data.data[0];
                yearMonthRequestObj = null;


                let currentYearMonth = '';
                let sameMonthLastYear = '';

                let currentYearMonthGwth = '';
                let sameMonthLastYearGwth = '';

                for (let i = 0; i < data.length; i++) {
                    currentYearMonth += parseInt(data[i].Curr_Year_Month) + ',';
                    sameMonthLastYear += parseInt(data[i].LY_Year_Month) + ',';
                    currentYearMonthGwth += parseInt(data[i].Grwth_Curr_Year_Month) + ',';
                    sameMonthLastYearGwth += parseInt(data[i].Grwth_LY_Year_Month) + ',';
                }

                yearMonthObj.currentYearMonth = currentYearMonth.slice(0, currentYearMonth.length - 1);
                yearMonthObj.sameMonthLastYear = sameMonthLastYear.slice(0, sameMonthLastYear.length - 1);

                yearMonthObj.currentYearMonthGwth = currentYearMonthGwth.slice(0, currentYearMonthGwth.length - 1);
                yearMonthObj.sameMonthLastYearGwth = sameMonthLastYearGwth.slice(0, sameMonthLastYearGwth.length - 1);

                skuwiseComposition(yearMonthObj);
                nobwiseComposition(yearMonthObj);
                zonewiseComposition(yearMonthObj);

            }),
            error: (function(e) {
                yearMonthRequestObj = null;
                if (e.status == 404) {
                    $(".mainContent").replaceWith("<p><h3  style='text-align: center; color: #e7875c;'>Server is down due to regular maintenance activities by our experts. Regret for inconvenience caused. Please access the dashboards again in a while ! </h3></p>");
                }
                console.log(e);

            })
        });

    }



    var globalSkuSpendPaginatedChartData = [];
    var globalSkuSalesPaginatedChartData = [];

    var globalSkuSpendPaginatedChartColor = [];
    var globalSkuSalesPaginatedChartColor = [];

    function skuwiseComposition(yearMonthObj) {
        let parentContainerid = 'skuContainer';
        let salesParentEle = $('#salesNavigationId').find('span');
        salesParentEle.css('cursor', "pointer");
        salesParentEle.find('i').removeClass('disabledCustom');

        let spendParentEle = $('#spendNavigationId').find('span');
        spendParentEle.css('cursor', "pointer");
        spendParentEle.find('i').removeClass('disabledCustom');

        showHideLoader(parentContainerid, true);
        if (skuwiseCompositionReqObj) {
            skuwiseCompositionReqObj.abort();
            skuwiseCompositionReqObj = null;
        }

        let filterData = createFilter();

        let currentYearMonth = yearMonthObj.currentYearMonth;
        let sameMonthLastYear = yearMonthObj.sameMonthLastYear;
        let currentYearMonthGwth = yearMonthObj.currentYearMonthGwth;
        let sameMonthLastYearGwth = yearMonthObj.sameMonthLastYearGwth;

        filterData.push({
            dataType: "String",
            key: 'currentYearMonth',
            value: currentYearMonth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYear',
            value: sameMonthLastYear
        });

        filterData.push({
            dataType: "String",
            key: 'currentYearMonthGwth',
            value: currentYearMonthGwth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYearGwth',
            value: sameMonthLastYearGwth
        });
        let procedureName = "Skuwise_CompositionView_Procedure";
        skuwiseCompositionReqObj = $.ajax({
            type: 'POST',
            url: getApiDomain(),
            data: JSON.stringify({
                chartDataForms: filterData,
                filter: procedureName,
                'filterHash': cTageHash(procedureName + JSON.stringify(filterData)),
                'dashboardId': dashboardId
            }),
            success: (function(dataResult) {
                showHideLoader(parentContainerid, false);
                let data = dataResult.data.data[0];
                globalSkuSalesChartData = prepareChartData(data, 'sku', 'LY_Sales', 'Curr_Sales', 'sales_lift_percentage', 'sales');
                globalSkuSpendChartData = prepareChartData(data, 'sku', 'LY_Spend', 'Curr_Spend', 'spend_lift_percentage', 'spend');

                globalSkuSalesPaginatedChartData = paginatedChartDataArr(globalSkuSalesChartData, currSkuSalesPage);
                globalSkuSpendPaginatedChartData = paginatedChartDataArr(globalSkuSpendChartData, currSkuSpendPage);

                globalSkuSalesPaginatedChartColor = paginatedColorDataArr(globalColorsArr, currSkuSalesPage);
                globalSkuSpendPaginatedChartColor = paginatedColorDataArr(globalColorsArr, currSkuSpendPage);

                createSkuAreaChart('skuwiseSalesDivId', globalSkuSalesPaginatedChartData, 'SKU wise Sales', globalSkuSalesPaginatedChartColor);
                createSkuAreaChart('skuwiseSpendDivId', globalSkuSpendPaginatedChartData, 'SKU wise Spend', globalSkuSpendPaginatedChartColor);

                if (data.length > skuLimit) {
                    $('.nextN').css('display', 'block');
                    $('.nextNSpnd').css('display', 'block');
                }
                skuwiseCompositionReqObj = null;
            }),
            error: (function(error) {
                skuwiseCompositionReqObj = null;
                showHideLoader(parentContainerid, false);
                console.log(error)
            })
        });
    }

    var nobwiseCompositionReqObj;
    var globalNobWiseSpendData = [];
    var globalNobWiseSalesData = [];

    function nobwiseComposition(yearMonthObj) {

        let parentContainerid = 'nobContainer';
        showHideLoader(parentContainerid, true);
        if (nobwiseCompositionReqObj) {
            nobwiseCompositionReqObj.abort();
            nobwiseCompositionReqObj = null;
        }

        let filterData = createFilter();

        let currentYearMonth = yearMonthObj.currentYearMonth;
        let sameMonthLastYear = yearMonthObj.sameMonthLastYear;
        let currentYearMonthGwth = yearMonthObj.currentYearMonthGwth;
        let sameMonthLastYearGwth = yearMonthObj.sameMonthLastYearGwth;

        filterData.push({
            dataType: "String",
            key: 'currentYearMonth',
            value: currentYearMonth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYear',
            value: sameMonthLastYear
        });

        filterData.push({
            dataType: "String",
            key: 'currentYearMonthGwth',
            value: currentYearMonthGwth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYearGwth',
            value: sameMonthLastYearGwth
        });
        let procedureName = "Nobwise_CompositionView_Procedure";
        nobwiseCompositionReqObj = $.ajax({
            type: 'POST',
            url: getApiDomain(),
            data: JSON.stringify({
                chartDataForms: filterData,
                filter: procedureName,
                'filterHash': cTageHash(procedureName + JSON.stringify(filterData)),
                'dashboardId': dashboardId
            }),
            success: (function(dataResult) {
                showHideLoader(parentContainerid, false);
                nobwiseCompositionReqObj = null;
                let data = dataResult.data.data[0];
                globalNobWiseSalesData = prepareChartData(data, 'nature_of_business', 'LY_Sales', 'Curr_Sales', 'sales_lift_percentage', 'sales');
                createNobAreaChart('nobwiseSalesDivId', globalNobWiseSalesData, 'Channel wise Sales');
                globalNobWiseSpendData = prepareChartData(data, 'nature_of_business', 'LY_Spend', 'Curr_Spend', 'spend_lift_percentage', 'spend');
                createNobAreaChart('nobwiseSpendDivId', globalNobWiseSpendData, 'Channel wise Spend');

            }),
            error: (function(error) {
                showHideLoader(parentContainerid, false);
                nobwiseCompositionReqObj = null;
                console.log(error)
            })
        });
    }

    var zonewiseCompositionReqObj;
    var globalZoneWiseSpendData = [];
    var globalZoneWiseSalesData = [];

    function zonewiseComposition(yearMonthObj) {

        let parentContainerid = 'zoneContainer'
        showHideLoader(parentContainerid, true);
        if (zonewiseCompositionReqObj) {
            zonewiseCompositionReqObj.abort();
            zonewiseCompositionReqObj = null;
        }

        let filterData = createFilter();

        let currentYearMonth = yearMonthObj.currentYearMonth;
        let sameMonthLastYear = yearMonthObj.sameMonthLastYear;
        let currentYearMonthGwth = yearMonthObj.currentYearMonthGwth;
        let sameMonthLastYearGwth = yearMonthObj.sameMonthLastYearGwth;

        filterData.push({
            dataType: "String",
            key: 'currentYearMonth',
            value: currentYearMonth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYear',
            value: sameMonthLastYear
        });

        filterData.push({
            dataType: "String",
            key: 'currentYearMonthGwth',
            value: currentYearMonthGwth
        });
        filterData.push({
            dataType: "String",
            key: 'sameMonthLastYearGwth',
            value: sameMonthLastYearGwth
        });
        let procedureName = "Zonewise_CompositionView_Procedure";
        zonewiseCompositionReqObj = $.ajax({
            type: 'POST',
            url: getApiDomain(),
            data: JSON.stringify({
                chartDataForms: filterData,
                filter: procedureName,
                'filterHash': cTageHash(procedureName + JSON.stringify(filterData)),
                'dashboardId': dashboardId
            }),
            success: (function(dataResult) {

                showHideLoader(parentContainerid, false);
                zonewiseCompositionReqObj = null;
                let data = dataResult.data.data[0];
                globalZoneWiseSalesData = prepareChartData(data, 'zone', 'LY_Sales', 'Curr_Sales', 'sales_lift_percentage', 'sales');
                createZoneAreaChart('zonewiseSalesDivId', globalZoneWiseSalesData, 'Region wise Sales');

                globalZoneWiseSpendData = prepareChartData(data, 'zone', 'LY_Spend', 'Curr_Spend', 'spend_lift_percentage', 'spend');
                createZoneAreaChart('zonewiseSpendDivId', globalZoneWiseSpendData, 'Region wise Spend');

            }),
            error: (function(error) {
                showHideLoader(parentContainerid, false);
                zonewiseCompositionReqObj = null;
                console.log(error)
            })
        });
    }

    $(document).on('change', '#yearFilter', function() {
        let filterName = $(this).val();
        let seleMonth = $("#monthFilter").val();
        $(this).data('options', $('#monthDependantComboId option').clone());
        var finalArr = $(this).data('options').filter('[class="' + filterName + '"]');

        var html = "";
        let selected = '';
        for (i = 0; i < finalArr.length; i++) {
            jQuery(finalArr[i]).removeAttr("class");
            selected = ''
            if (finalArr[i].value == seleMonth) {
                selected = 'selected';
            }
            html += "<option value='" + finalArr[i].value + "' " + selected + ">" + finalArr[i].text + "</option>"
        }
        $("#monthFilter").html(html);

    });
    $(document).on("change", "#sku_filter_id", function() {
        $("#sku_filter_id option:selected").each(function() {
            var $this = $(this);
            if ($this.length) {
                var selText = $this.val();
                filterValueSku.push(selText);
            }
        });
    });
    $(document).on("change", ".filter", function() {
        if (this.name != "sku")
            populateFilterCombo();
        if (this.name == 'brand') {
            filterValueSku = [];
        }
        refreshPaginatedData();
        globalChartSelectionFilter = null;

        let filterName = $(this).attr('name');
        let selectedOptionsList = $(this).find("option:selected");
        let selectedOptions = '';
        for (let i = 0; i < selectedOptionsList.length; i++) {
            selectedOptions += jQuery(selectedOptionsList[i]).text() + ",";
        }
        $("#filterChange").show();
        if (userId != undefined) {
            trackCustomEvent('Filter Changed', {
                "companyId": companyId.toString(),
                "userId": userId.toString(),
                "dashboardId": dashboardId.toString(),
                "reportName": dashboardFullName.toString(),
                "filterName": filterName.toString(),
                "filterValue": selectedOptions.toString()
            });
        }
    });

    function onClickGo(filter){
        yearMonthObjAPi();
        let selectedOptionsList = $(".filter").find("option:selected");
        let selectedOptions = '';
        for (let i = 0; i < selectedOptionsList.length; i++) {
            selectedOptions += jQuery(selectedOptionsList[i]).text() + ",";
        }
        $("#filterChange").hide();
        if (userId != undefined) {
            trackCustomEvent('Go Button', {
                "companyId": companyId.toString(),
                "userId": userId.toString(),
                "dashboardId": dashboardId.toString(),
                "reportName": dashboardFullName.toString(),
                // "filterName": "".toString(),
                "filterValue": filter.toString
            });
        }
    }
    $("#goButton").click(function() {
        yearMonthObjAPi();
        let selectedOptionsList = $(".filter").find("option:selected");
        let selectedOptions = '';
        for (let i = 0; i < selectedOptionsList.length; i++) {
            selectedOptions += jQuery(selectedOptionsList[i]).text() + ",";
        }
        $("#filterChange").hide();
        if (userId != undefined) {
            trackCustomEvent('Go Button', {
                "companyId": companyId.toString(),
                "userId": userId.toString(),
                "dashboardId": dashboardId.toString(),
                "reportName": dashboardFullName.toString(),
                // "filterName": "".toString(),
                "filterValue": selectedOptions.toString()
            });
        }
    });

    function refreshDashboard() {
    preSelectedFilterArray = [];
    resetFilters = true;
    defaultBrand = true;
    filterSelected = [];
    showHideLoader('skuContainer', true);
    showHideLoader('nobContainer', true);
    showHideLoader('zoneContainer', true);
    $("#filterChange").hide();
    onload = true;
    $("#sku_filter_id").empty();
    $("#sku_filter_id").multiselect('destroy');
    filterValueSku = [];
    $("#brand_filter_id").empty();

    populateFilterCombo();
}
    /// END  : ON CHANGE


    //START : COMMON FUNCTION
    function createFilter() {
        let filterData = [];
        $(".filter").each(function() {
            let filterValue = $(this).val();
            let filterName = $(this).attr("name");
            if (filterValue == null || filterValue == undefined) {
                filterValue = "";
            }
            if (!(filterName == 'month' || filterName == 'year')) {
                filterData.push({
                    dataType: "String",
                    key: filterName,
                    value: filterValue.toString()
                });
            }
        });
        if (globalChartSelectionFilter) {
            let filterIndex = filterData.findIndex(x => x.key == globalChartSelectionFilter.key);

            if (filterIndex == -1) {
                filterData.push(globalChartSelectionFilter);
            } else {
                let obj = filterData[filterIndex];
                obj.value = globalChartSelectionFilter.value
            }
        }
        return filterData;
    }

    function prepareChartData(dataResult, key1, key2, key3, key4, customChartType = '') {
        let dataArr = [];
        let dataObj;
        for (let i = 0; i < dataResult.length; i++) {
            dataObj = {
                name: '',
                data: [],
                customChartType: customChartType
            };
            dataObj.name = dataResult[i][key1];
            dataObj.lift_perc = dataResult[i][key4] * 1;
            dataObj.data.push(dataResult[i][key2] * 1);
            dataObj.data.push(dataResult[i][key3] * 1);
            dataArr.push(dataObj);
        }
        // return dataArr
        // return sortByKeyDesc(dataArr, 'lift_perc');
        return sortByKeyDesc(dataArr, 'data');
    }

    function sortByKeyDesc(array, key) {

        return array.sort(function(a, b) {
            var x = a[key][1];
            var y = b[key][1];
            return ((x > y) ? -1 : ((x < y) ? 1 : 0));
        });
    }

    function numberFormatter(num, prefixSymbol = "", suffixSymbol = "") {

        num = parseFloat(num);
        if (isNaN(num)) {
            return "NA";
        }


        if (suffixSymbol != '') {
            return prefixSymbol + getnum(num) + suffixSymbol;
        } else {
            return prefixSymbol + getnum(num / 100000) + " L";
        }

    }

    function getnum(calcNum) {
        let temp = calcNum.toFixed(2);
        return (new Intl.NumberFormat('en-IN').format(temp));

    }

    function navigateSalesSkuChart(direction) {

        if (direction == 'next') {
            currSkuSalesPage += 1;
            $('.prevN').css('display', 'block');
        } else {
            $('.nextN').css('display', 'block');
            currSkuSalesPage -= 1;
        }
        if (currSkuSalesPage == 1) {
            $('.prevN').css('display', 'none');
        }

        let lastPg = currSkuSalesPage * skuLimit;
        if (lastPg >= globalSkuSalesChartData.length) {
            $('.nextN').css('display', 'none');
        }

        globalSkuSalesPaginatedChartData = paginatedChartDataArr(globalSkuSalesChartData, currSkuSalesPage);
        globalSkuSalesPaginatedChartColor = paginatedColorDataArr(globalColorsArr, currSkuSalesPage);
        createSkuAreaChart('skuwiseSalesDivId', globalSkuSalesPaginatedChartData, 'SKU wise Sales', globalSkuSalesPaginatedChartColor);


    }

    function navigateSpendSkuChart(direction) {

        if (direction == 'next') {
            currSkuSpendPage += 1;
            $('.prevNSpnd').css('display', 'block');
        } else {
            $('.nextNSpnd').css('display', 'block');
            currSkuSpendPage -= 1;
        }
        if (currSkuSpendPage == 1) {
            $('.prevNSpnd').css('display', 'none');
        }

        let lastPg = currSkuSpendPage * skuLimit;
        if (lastPg >= globalSkuSpendChartData.length) {
            $('.nextNSpnd').css('display', 'none');
        }

        globalSkuSpendPaginatedChartData = paginatedChartDataArr(globalSkuSpendChartData, currSkuSpendPage);
        globalSkuSpendPaginatedChartColor = paginatedColorDataArr(globalColorsArr, currSkuSpendPage);
        createSkuAreaChart('skuwiseSpendDivId', globalSkuSpendPaginatedChartData, 'SKU wise Spend', globalSkuSpendPaginatedChartColor);

    }


    function paginatedChartDataArr(chartArr, currPage) {

        let paginatedArr = [];
        let endIndex = currPage * skuLimit;
        let startIndex = currPage * skuLimit - skuLimit;
        endIndex = chartArr.length > endIndex ? endIndex : chartArr.length;
        for (let i = startIndex; i < endIndex; i++) {
            paginatedArr.push(chartArr[i]);
        }
        return paginatedArr;

    }

    function paginatedColorDataArr(colorArr, currPage) {

        let paginatedColorArr = [];
        let endIndex = currPage * skuLimit;
        let startIndex = currPage * skuLimit - skuLimit;
        endIndex = colorArr.length > endIndex ? endIndex : colorArr.length;
        for (let i = startIndex; i < endIndex; i++) {
            paginatedColorArr.push(colorArr[i]);
        }
        return paginatedColorArr;

    }


    function refreshPaginatedData() {

        currSkuSalesPage = 1;
        currSkuSpendPage = 1;
        $('.nextN').css('display', 'none');
        $('.prevN').css('display', 'none');
        $('.nextNSpnd').css('display', 'none');
        $('.prevNSpnd').css('display', 'none');
    }

    function showHideLoader(containerId, display) {
        if (display) {
            // $("#" + containerId).empty();
            $("#" + containerId).prepend("<div class='loader'></div>");
        } else {
            $("#" + containerId).find('div[class="loader"]').remove();
        }
    }
    //END : COMMON FUNCTION

    //SKu area Chart
    function createSkuAreaChart(containerId, chartData, title, filteredColorArr) {
        let chartOptions = {

            chart: {
                type: 'area',
                renderTo: containerId
            },
            title: {
                text: title,
                style: {
                    fontSize: '12px'
                }
            },
            subtitle: {
                text: null
            },
            colors: filteredColorArr,
            xAxis: {
                categories: categoryList,
                tickmarkPlacement: 'on',
                title: {
                    enabled: false
                }
            },
            legend: {
                useHTML: true,
                enabled: true,
                layout: 'horizontal',
                // itemDistance: '20',
                maxHeight: 50,
                align: 'centre',
                itemStyle: {
                    fontSize: "8px",
                    fontWeight: "normal"
                },
                navigation: {
                    arrowSize: 8
                },
                labelFormatter: function() {

                    let name = this.name;

                    if (name.length > 20 && chartData.length > 1) {
                        let finalName = name.substr(0, 6) + '....' + name.substr(-6);

                        return '<div title="' + this.name + '">' + finalName + '</div>';
                    } else {
                        return this.name;
                    }


                }

            },
            yAxis: {
                labels: {
                    enabled: false
                        // format: '{value}%'
                },
                title: {
                    enabled: false
                }
            },
            tooltip: {
                useHTML: true,
                outside: true,
                formatter: function() {
                    let name = this.series.name;
                    let perc = chartData[this.series.index]['lift_perc'];
                    let value = this.y;
                    let color = this.color;

                    if (this.key == $('#yearFilter option:selected').text()) {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(2) + '%)</b><br/>';
                    } else {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + '</b><br/>';
                    }
                },
                split: false
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true,
                        outside: false,
                        padding: 0,
                        allowOverlap: true,
                        enabled: true,
                        visible: true,
                        verticalAlign: 'top',
                        style: {
                            color: 'black',
                            fontSize: 10
                        },
                        formatter: function() {
                            let perc = chartData[this.series.index]['lift_perc'];
                            if (this.key == $('#yearFilter option:selected').text()) {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(2) + '%)';
                            } else {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>');
                            }
                        }
                    },
                    trackByArea: true,
                    events: {
                        click: function(event) {

                            let selectedAreaIndex = this.index;
                            let chartType = this.chart.series[selectedAreaIndex].options.customChartType;
                            let parentSpanEle;
                            if (chartType == 'sales') {
                                parentSpanEle = $('#salesNavigationId').find('span');
                            } else {
                                parentSpanEle = $('#spendNavigationId').find('span');
                            }
                            if (this.selected) {
                                globalChartSelectionFilter = null;
                                this.chart.series.forEach((obj, loopIndex) => {
                                    obj.update({
                                        opacity: '1'
                                    });
                                });
                                this.selected = false;
                                parentSpanEle.css('cursor', "pointer");
                                parentSpanEle.find('i').removeClass('disabledCustom');
                            } else {
                                let skuObj = globalSkuFilterData.find(x => {
                                    return x.sku == this.name.toString()
                                });
                                let skuId = skuObj ? skuObj.id : 0;
                                globalChartSelectionFilter = {
                                    dataType: "String",
                                    key: "sku",
                                    value: skuId.toString()
                                };
                                this.chart.series.forEach((obj, loopIndex) => {
                                    if (loopIndex == selectedAreaIndex) {
                                        obj.update({
                                            opacity: '1'
                                        });
                                    } else {
                                        obj.update({
                                            opacity: '0.2'
                                        });
                                        obj.selected = false;
                                    }
                                })
                                this.selected = true;
                                parentSpanEle.css('cursor', "not-allowed");
                                parentSpanEle.find('i').addClass('disabledCustom');
                            }
                            nobwiseComposition(yearMonthObj);
                            zonewiseComposition(yearMonthObj);
                            if (chartType == 'sales') {
                                let ele = $('#spendNavigationId').find('span');
                                ele.css('cursor', "pointer");
                                ele.find('i').removeClass('disabledCustom');
                                createSkuAreaChart('skuwiseSpendDivId', globalSkuSpendPaginatedChartData, 'SKU wise Spend', globalSkuSpendPaginatedChartColor);
                            } else {
                                let ele = $('#salesNavigationId').find('span');
                                ele.css('cursor', "pointer");
                                ele.find('i').removeClass('disabledCustom');
                                createSkuAreaChart('skuwiseSalesDivId', globalSkuSalesPaginatedChartData, 'SKU wise Sales', globalSkuSalesPaginatedChartColor);
                            }
                        }
                    },
                    marker: {
                        enabled: false,
                        symbol: 'diamond'
                    },
                },
                area: {
                    stacking: 'percent',
                    lineColor: '#ffffff',
                    lineWidth: 1,
                    // marker: {
                    //     lineWidth: 1,
                    //     lineColor: '#ffffff'
                    // },
                    accessibility: {
                        pointDescriptionFormatter: function(point) {
                            function round(x) {
                                return Math.round(x * 100) / 100;
                            }
                            return (point.index + 1) + ', ' + point.category + ', ' +
                                point.y + ' millions, ' + round(point.percentage) + '%, ' +
                                point.series.name;
                        }
                    }
                }
            },
            series: chartData,
            navigation: {
                buttonOptions: {
                    align: 'right',
                    y: 30
                }
            }
        };

        let chart = new Highcharts.Chart(chartOptions);
        if (chartData.length == 0) {
            chart.renderer.text('No Data Available', 140, 120)
                .css({
                    color: '#4572A7',
                    fontSize: '12px'
                })
                .add();
        }
    }

    //NOB Area Chart
    function createNobAreaChart(containerId, chartData, title) {
        let chartOptions = {
            chart: {
                type: 'area',
                renderTo: containerId
            },
            title: {
                text: title,
                style: {
                    fontSize: '12px'
                }
            },
            subtitle: {
                text: null
            },
            colors: globalColorsArr,
            xAxis: {
                categories: categoryList,
                tickmarkPlacement: 'on',
                title: {
                    enabled: false
                }
            },
            legend: {
                enabled: true,
                layout: 'horizontal',
                // itemDistance: '20',
                maxHeight: 50,
                align: 'center',
                itemStyle: {
                    fontSize: "8px",
                    fontWeight: "normal"
                },
                navigation: {
                    arrowSize: 8
                }

            },
            yAxis: {
                labels: {
                    enabled: false
                        // format: '{value}%'
                },
                title: {
                    enabled: false
                }
            },
            tooltip: {
                useHTML: true,
                formatter: function() {
                    let name = this.series.name;
                    let perc = chartData[this.series.index]['lift_perc'];
                    let value = this.y;
                    let color = this.color;

                    if (this.key == $('#yearFilter option:selected').text()) {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(2) + '%)</b><br/>';
                    } else {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + '</b><br/>';
                    }
                },
                split: false
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true,
                        outside: false,
                        padding: 0,
                        allowOverlap: true,
                        enabled: true,
                        visible: true,
                        verticalAlign: 'top',
                        style: {
                            color: 'black',
                            fontSize: 10
                        },
                        formatter: function() {
                            let perc = chartData[this.series.index]['lift_perc'];
                            if (this.key == $('#yearFilter option:selected').text()) {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(2) + '%)';
                            } else {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>');
                            }
                        }
                    },
                    trackByArea: true,
                    events: {
                        click: function(event) {
                            let selectedAreaIndex = this.index;
                            let chartType = this.chart.series[selectedAreaIndex].options.customChartType;
                            if (this.selected) {
                                globalChartSelectionFilter = null;
                                this.chart.series.forEach((obj, loopIndex) => {
                                    obj.update({
                                        opacity: '1'
                                    });
                                });
                                this.selected = false;
                            } else {

                                globalChartSelectionFilter = {
                                    dataType: "String",
                                    key: "nob",
                                    value: this.name.toString()
                                };
                                this.chart.series.forEach((obj, loopIndex) => {
                                    if (loopIndex == selectedAreaIndex) {
                                        obj.update({
                                            opacity: '1'
                                        });
                                    } else {
                                        obj.update({
                                            opacity: '0.2'
                                        });
                                        obj.selected = false;
                                    }
                                })
                                this.selected = true;
                            }
                            skuwiseComposition(yearMonthObj);
                            zonewiseComposition(yearMonthObj);
                            if (chartType == 'sales') {
                                createNobAreaChart('nobwiseSpendDivId', globalNobWiseSpendData, 'Channel wise Spend');
                            } else {
                                createNobAreaChart('nobwiseSalesDivId', globalNobWiseSalesData, 'Channel wise Sales');
                            }
                        }
                    },
                    marker: {
                        enabled: false,
                        symbol: 'diamond'
                    }
                },
                area: {
                    stacking: 'percent',
                    lineColor: '#ffffff',
                    lineWidth: 1,
                    // marker: {
                    //     lineWidth: 1,
                    //     lineColor: '#ffffff'
                    // },
                    accessibility: {
                        pointDescriptionFormatter: function(point) {
                            function round(x) {
                                return Math.round(x * 100) / 100;
                            }
                            return (point.index + 1) + ', ' + point.category + ', ' +
                                point.y + ' millions, ' + round(point.percentage) + '%, ' +
                                point.series.name;
                        }
                    }
                }
            },
            series: chartData
        };

        let chart = new Highcharts.Chart(chartOptions);
        if (chartData.length == 0) {
            chart.renderer.text('No Data Available', 140, 120)
                .css({
                    color: '#4572A7',
                    fontSize: '12px'
                })
                .add();
        }
    }

    //Zone Area Chart
    function createZoneAreaChart(containerId, chartData, title) {
        let chartOptions = {
            chart: {
                type: 'area',
                renderTo: containerId
            },
            title: {
                text: title,
                style: {
                    fontSize: '12px'
                }
            },
            subtitle: {
                text: null
            },
            colors: globalColorsArr,
            xAxis: {
                categories: categoryList,
                tickmarkPlacement: 'on',
                title: {
                    enabled: false
                }
            },
            legend: {
                enabled: true,
                layout: 'horizontal',
                // itemDistance: '20',
                maxHeight: 50,
                align: 'center',
                itemStyle: {
                    fontSize: "8px",
                    fontWeight: "normal"
                },
                navigation: {
                    arrowSize: 8
                }

            },
            yAxis: {
                labels: {
                    enabled: false
                        // format: '{value}%'
                },
                title: {
                    enabled: false
                }
            },
            tooltip: {
                useHTML: true,
                formatter: function() {
                    let name = this.series.name;
                    let perc = chartData[this.series.index]['lift_perc'];
                    let value = this.y;
                    let color = this.color;

                    if (this.key == $('#yearFilter option:selected').text()) {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(1) + '%)</b><br/>';
                    } else {
                        return '<span style="color:' + color + '">' + name + '</span>: <b>' + numberFormatter(value, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + '</b><br/>';
                    }
                },
                split: false
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true,
                        outside: false,
                        padding: 0,
                        allowOverlap: true,
                        enabled: true,
                        visible: true,
                        verticalAlign: 'top',
                        style: {
                            color: 'black',
                            fontSize: 10
                        },
                        formatter: function() {
                            let perc = chartData[this.series.index]['lift_perc'];
                            if (this.key == $('#yearFilter option:selected').text()) {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>') + ' (' + (perc * 1).toFixed(2) + '%)';
                            } else {
                                return numberFormatter(this.y, prefixSymbol = '<i class="fa fa-inr" aria-hidden="true"></i>');
                            }
                        }
                    },
                    trackByArea: true,
                    events: {
                        click: function(event) {
                            let selectedAreaIndex = this.index;
                            let chartType = this.chart.series[selectedAreaIndex].options.customChartType;
                            if (this.selected) {
                                globalChartSelectionFilter = null;
                                this.chart.series.forEach((obj, loopIndex) => {
                                    obj.update({
                                        opacity: '1'
                                    });
                                });
                                this.selected = false;
                            } else {

                                globalChartSelectionFilter = {
                                    dataType: "String",
                                    key: "zone",
                                    value: this.name.toString()
                                };
                                this.chart.series.forEach((obj, loopIndex) => {
                                    if (loopIndex == selectedAreaIndex) {
                                        obj.update({
                                            opacity: '1'
                                        });
                                    } else {
                                        obj.update({
                                            opacity: '0.2'
                                        });
                                        obj.selected = false;
                                    }
                                })
                                this.selected = true;
                            }
                            skuwiseComposition(yearMonthObj);
                            nobwiseComposition(yearMonthObj);
                            if (chartType == 'sales') {
                                createZoneAreaChart('zonewiseSpendDivId', globalZoneWiseSpendData, 'Region wise Spend');
                            } else {
                                createZoneAreaChart('zonewiseSalesDivId', globalZoneWiseSalesData, 'Region wise Sales');
                            }
                        }
                    },
                    marker: {
                        enabled: false,
                        symbol: 'diamond'
                    }
                },
                area: {
                    stacking: 'percent',
                    lineColor: '#ffffff',
                    lineWidth: 1,
                    // marker: {
                    //     lineWidth: 1,
                    //     lineColor: '#ffffff'
                    // },
                }
            },
            series: chartData
        };

        let chart = new Highcharts.Chart(chartOptions);
        if (chartData.length == 0) {
            chart.renderer.text('No Data Available', 140, 120)
                .css({
                    color: '#4572A7',
                    fontSize: '12px'
                })
                .add();
        }
    }
</script>

</html>